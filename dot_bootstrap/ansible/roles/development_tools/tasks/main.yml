---
- name: Install 1Password CLI (mac)
  homebrew:
    name: 1password-cli
    state: present
  when: ansible_os_family == 'Darwin'

- name: Install 1Password CLI (linux APT)
  shell: |
    curl -sS https://downloads.1password.com/linux/keys/1password.asc | \
    gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main" | \
    tee /etc/apt/sources.list.d/1password.list && \
    mkdir -p /etc/debsig/policies/AC2D62742012EA22/ && \
    curl -sS https://downloads.1password.com/linux/debian/debsig/1password.pol | \
    tee /etc/debsig/policies/AC2D62742012EA22/1password.pol && \
    mkdir -p /usr/share/debsig/keyrings/AC2D62742012EA22 && \
    curl -sS https://downloads.1password.com/linux/keys/1password.asc | \
    gpg --dearmor --output /usr/share/debsig/keyrings/AC2D62742012EA22/debsig.gpg && \
    apt update && apt install 1password-cli
  args:
    executable: /bin/bash
  when: ansible_os_family == 'Debian'
  become: yes

- name: Install GitHub CLI (macos)
  homebrew:
    name: gh
    state: present
  when: ansible_os_family == 'Darwin' 


- name: Install GitHub CLI (linux APT)
  shell: |
    (type -p wget >/dev/null || (apt update && apt install wget -y)) \
    && mkdir -p -m 755 /etc/apt/keyrings \
    && out=$(mktemp) && wget -nv -O$out https://cli.github.com/packages/githubcli-archive-keyring.gpg \
    && cat $out | tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null \
    && chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg \
    && mkdir -p -m 755 /etc/apt/sources.list.d \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
    && apt update \
    && apt install gh -y
  args:
    executable: /bin/bash
  when: ansible_os_family == 'Debian'
  become: yes


- name: Install additional development tools (cargo)
  community.general.cargo:
    name: eza

- name: Install additional development tools
  shell: |
    # Install delta for better git diffs
    {{ 'brew install git-delta' if ansible_os_family == 'Darwin' else 'wget -O delta.deb https://github.com/dandavison/delta/releases/download/0.16.5/git-delta_0.16.5_amd64.deb && sudo dpkg -i delta.deb && rm delta.deb' }}

    # # Install starship (cross-shell prompt)
    curl -sS https://starship.rs/install.sh | sh -s -- -y

    # Install asdf (version manager)
    {{ 'brew install asdf' if ansible_os_family == 'Darwin' else 'git clone https://github.com/asdf-vm/asdf.git ~/.asdf --branch v0.14.0' }}

    # Install direnv (environment switcher)
    {{ 'brew install direnv' if ansible_os_family == 'Darwin' else 'curl -sfL https://direnv.net/install.sh | bash' }}
  args:
    executable: /bin/bash

- name: Configure GitHub CLI
  shell: |
    gh auth login --with-token < /dev/null || true
    gh config set git_protocol https
    gh config set editor nvim
  ignore_errors: yes

- name: Set up SSH configuration
  file:
    path: ~/.ssh
    state: directory
    mode: '0700'

- name: Create SSH config
  template:
    src: ssh_config.j2
    dest: ~/.ssh/config
    mode: '0600'

- name: Set up GPG
  shell: |
    gpg --list-keys || gpg --generate-key --batch <<EOF
    %no-protection
    Key-Type: RSA
    Key-Length: 4096
    Name-Real: {{ git_user_name }}
    Name-Email: {{ git_user_email }}
    Expire-Date: 0
    %commit
    EOF
  ignore_errors: yes

- name: Configure Git with GPG
  git_config:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    scope: global
  loop:
    - { name: "commit.gpgsign", value: "true" }
    - { name: "gpg.program", value: "gpg" }
  when: gpg_key_id is defined
