---
- name: Install chezmoi (macOS)
  homebrew:
    name: chezmoi
    state: present
  when: ansible_os_family == 'Darwin'

- name: Install chezmoi (Linux)
  shell: |
    set -euo pipefail
    sh -c "$(curl -fsLS get.chezmoi.io)" -- -b "$HOME/.local/bin"
  args:
    executable: /bin/bash
  when: ansible_os_family != 'Darwin'

- name: Ensure ~/.local/bin on PATH (Linux)
  lineinfile:
    path: ~/.profile
    create: yes
    line: 'export PATH="$HOME/.local/bin:$PATH"'
    state: present
    insertafter: EOF
  when: ansible_os_family != 'Darwin'
  loop:
    - ~/.profile
    - ~/.zprofile
    - ~/.bashrc
    - ~/.bash_profile

- name: check if 'op' is installed
  ansible.builtin.command: which op
  register: op_check
  ignore_errors: true

- name: Install 1Password CLI (macOS)
  homebrew:
    name: 1password-cli
    state: present
  when: ansible_os_family == 'Darwin' and op_check.rc != 0

- name: Install 1Password CLI (Debian/Ubuntu)
  shell: |
    set -euo pipefail
    (type -p gpg >/dev/null 2>&1) || (apt update && apt install -y gnupg)
    curl -sS https://downloads.1password.com/linux/keys/1password.asc | \
      gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main" | \
      tee /etc/apt/sources.list.d/1password.list
    mkdir -p /etc/debsig/policies/AC2D62742012EA22/
    curl -sS https://downloads.1password.com/linux/debian/debsig/1password.pol | \
      tee /etc/debsig/policies/AC2D62742012EA22/1password.pol
    mkdir -p /usr/share/debsig/keyrings/AC2D62742012EA22
    curl -sS https://downloads.1password.com/linux/keys/1password.asc | \
      gpg --dearmor --output /usr/share/debsig/keyrings/AC2D62742012EA22/debsig.gpg
    apt update
    apt install -y 1password-cli
  args:
    executable: /bin/bash
  when: ansible_os_family == 'Debian' and op_check.rc != 0
  become: true

- name: Display next steps
  debug:
    msg:
      - "If using 1Password, run: op account add --address <your>.1password.com"
      - "Then: eval $(op signin --account <your>)"
      - "Next: chezmoi init --apply"


